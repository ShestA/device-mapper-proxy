# Device mapper proxy
Маппер устройств, выполненный в формате модуля ядра, и собирающий статистику запросов на чтение и запись к привязанным блочным устройствам.

Поддерживаемые ститистические данные:
- Количество запросов на запись;
- Количество запросов на чтение;
- Средний размер блока на запись;
- Средний размер блока на чтение;
- Общее количество запросов;
- Средний размер блока.
## Сборка и установка
Требования:

- make   >= 4.2.1
- gcc    >= 9.3.0
- kernel >= 5.4.0 (работа с версиями 5.5.0 и выше не гарантирована)

**ВНИМАНИЕ: Для запуска bash-скриптов может потребоваться изменение прав доступа к скриптам командой:**
```bash
# chmod +x /path/to/device-mapper-proxy/scripts/ScriptName.sh
```
1)  Для сборки модуля перейдите в директорию /path/to/device-mapper-proxy/scripts и запустите bash-файл Make.sh.

>Перед процессом сборки скрипт проверит наличие make и gcc, и при необходимости попросит их установить.  
>Скрипт Make.sh может запускаться с параметром --clean для чистой сборки.

2)  После успешной сборки перейдите во вновь созданную директорию /path/to/device-mapper-proxy/dist.  
В директории dist должен появится файл *dmp.ko*. Модуль dmp.ko загрузите в систему командой
```bash
# insmod dmp.ko
```
Теперь модуль-маппер загружен в систему и может использоваться.  
Для проверки корректной загрузки модуля воспользуйтесь командой
```bash
$ lsmod | grep dmp
```
В консоли должно появится название загруженного модуля, занимаемое пространство и количество присоединенных устройств.

## Использование
После того, как модуль собран и загружен в память, его можно использовать. Собираемую статистику можно получить из /sys/module/dmp/stat/volumes командой 
```bash
# cat /sys/module/dmp/stat/volumes
```
Пример вывода статистики:
```bash
read:
  reqs: 500
  avg size: 4096
write:
  reqs: 100
  avg size: 4096
total:
  reqs: 600
  avg size: 4096
```
Маппер устройства создается командой dmsetup. Подробное использование команды и модуля описано в разделе **Примеры использования прокси-маппера**.

## Тестирование
Для тестирования предлагается 3 скрипта:
1) Test.sh $size - тестирование записи из устройства random в устройство zero, чтения из устройства zero в устройство null; size - размер устройства
2) LoopTest.sh - тестирование чтения и записи в устройство Loop9, подключенного к файлу /tmp/disk
3) FSTest.sh - тестирование записи gdb в устройство Loop9, подключенного к файлу /tmp/disk с установленной файловой системой ext4

**ВНИМАНИЕ: Устройство Loop9 может не существовать в Вашей системе.  Проверьте какие loop устройства используются командой ```$ losetup -a``` и замените в скриптах Loop9 на LoopN, где N - число на единицу больше старшего используемого Loop устройства.**

## Примеры использования прокси-маппера:
### Умная папка
```bash
### Загрузка модуля в память
# insmod path/to/module/dmp.ko
### Создание файла
# dd if=/dev/zero of=/path/to/file-disk bs=4k count=20000
### Подключение loop устройства к файлу, для получения доступа к файлу
# losetup /dev/loop0 /path/to/file-disk
### Создание маппера loop устройства
# dmsetup create disk_mapper --table "0 160000 proxy /dev/loop0 0"
### Создание файловой системы ext4
# mkfs -t ext4 /dev/mapper/disk_mapper 80000
### Монтирование устройства, для доступа к нему из файлового менеджера
# mount -t ext4 /dev/mapper/disk_mapper /path/to/mnt
### Изменение прав доступа к устройству, для чтения и записи через файловый менеджер
# chmod 666 /path/to/mnt
### Работа с подключенным устройством в файловой системе ext4 через файловый менеджер
# Получение текущей статистики прокси-устройства
# cat /sys/module/dmp/stat/volumes
### Демонтирование устройства
# umount /mnt
### Удаление маппера
# dmsetup remove disk_mapper
### Отключение loop устройства от папки
# losetup -d /dev/loop9
### Удаление файла
# rm /path/to/file-disk
### Выгрузка модуля
# rmmod dmp
```
### Защищенная умная папка
```bash
### Загрузка модуля в память
# insmod path/to/module/dmp.ko
### Создание файла
# dd if=/dev/zero of=/path/to/file-disk bs=4k count=20000
### Подключение loop устройства к файлу, для получения доступа к файлу
# losetup /dev/loop0 /path/to/file-disk
### Создание маппера loop устройства
# dmsetup create disk_mapper --table "0 160000 proxy /dev/loop0 0"
### Создание маппера-зашифровщика
# dmsetup create crypt_disk --table '0 160000 crypt aes-xts-plain64 babebabebabebabebabebabebabebabebabebabebabebabebabebabebabebabe 0 /dev/mapper/disk_mapper 0 1 allow_discards'
### Создание файловой системы ext4
# mkfs -t ext4 /dev/mapper/crypt_disk 80000
### Монтирование устройства, для доступа к нему из файлового менеджера
# mount -t ext4 /dev/mapper/crypt_disk /path/to/mnt
### Изменение прав доступа к устройству, для чтения и записи через файловый менеджер
# chmod 666 /path/to/mnt
### Работа с подключенным устройством в файловой системе ext4 через файловый менеджер
# Получение текущей статистики прокси-устройства
# cat /sys/module/dmp/stat/volumes
### Демонтирование устройства
# umount /mnt
### Удаление маппера-шифровщика
# dmsetup remove crypt_disk
### Удаление маппера
# dmsetup remove disk_mapper
### Отключение loop устройства от папки
# losetup -d /dev/loop0
### Удаление файла
# rm /path/to/file-disk
### Выгрузка модуля
# rmmod dmp
```
## ЧаВО:
- В: Прикольный модуль. Интересно посмотреть сколько террабайт данных я туда сюда таскаю каждый день. А это не опасно? Вдруг я установлю, а потом все файлы пропадут или вирусы какие-то.

О: Модуль действительно интересный! Не волнуйтесь, данный модуль собирает информацию о запросах к устройствам, присоединенным к модулю. Сами запросы он никак не использует. При необходимости Вы можете передавать уже зашифрованные данные (смотри **Примеры использования прокси-маппера**).

- В: Как вы написали этот модуль?

О: Хороший вопрос! Это мой первый модуль ядра Linux. Поэтому, получив такое задание, я не сразу понял что от меня хотят, а главное зачем? Но разобравшись в вопросе, оказалось, что все не так уж сложно. За основу модуля был взят [исходный код](https://elixir.bootlin.com/linux/v5.4/source/drivers/md/dm-linear.c) линейного маппера ядра Linux. Был вырезан функционал прямого доступа к устройству и добавлен функционал сбора статистики.

- В: Посоветуйте ссылки на источники, где можно побольше узнать о модулях.

О: К сожалению источников с подробным описанием создания и применения модулей ядра я посоветовать не могу. Но есть несколько сайтов, на которых можно найти много полезной информации по данной теме. Вот ссылки:
|Источник|Описание|
|------|------|
|[Bootlin](https://elixir.bootlin.com/linux/latest/source)|Исходный код ядра Linux разных версий|
|[Cyberforum](https://www.cyberforum.ru)|Форум программистов, где иногда можно найти полезные треды|
|[LWN](https://lwn.net)|Сообщество Linux разработчиков|
|[StackOverflow](https://stackoverflow.com/)|Иногда твой вопрос уже задавали миллион раз, а иногда никто о таком и не слышал|
|[Kernel.org](https://www.kernel.org/doc/Documentation/)|Документация ядра Linux|
|[Google](https://www.google.com/)|Поисковая система(можно выбрать другую или пользоваться многими)|
